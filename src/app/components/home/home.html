<div class="home-container">

  <header class="home-header">
    <h2>CURE D'ÂME 2025 - Fil d'Actualité</h2>

    <p class="program-info">Jour actuel : {{ posts.length > 0 ? 21 - (posts.length % 21) : 'Chargement...' }}</p>

    <button mat-raised-button [color]="showCreatePost ? 'warn' : 'accent'" (click)="toggleCreatePostForm()">
      <mat-icon>{{ showCreatePost ? 'close' : 'add' }}</mat-icon>
      {{ showCreatePost ? 'Annuler la Publication' : 'Publier un Contenu' }}
    </button>
  </header>

  @if (showCreatePost) {
      <app-create-post (postCreated)="onPostCreated()"></app-create-post>
      <mat-divider style="margin: 20px 0;"></mat-divider>
  }
  <div *ngIf="isLoading" class="loading-spinner">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Chargement des messages de transformation...</p>
  </div>

  <div *ngIf="errorMessage" class="error-message">
    <p>{{ errorMessage }}</p>
    <button mat-button color="primary" (click)="loadPosts()">Réessayer</button>
  </div>

  <div *ngIf="!isLoading && !errorMessage" class="post-feed">
    <mat-card *ngFor="let post of posts; trackBy: trackById" class="post-card">
      <mat-card-header>
        <div mat-card-avatar class="post-avatar">
            <mat-icon color="primary">{{ getIcon(post.type) }}</mat-icon>
        </div>
        <mat-card-title>{{ post.title }}</mat-card-title>
        <mat-card-subtitle>
          Publié par **{{ post.user.name }}** le **{{ post.created_at | date:'mediumDate' }}**
        </mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <p class="post-content">{{ post.content }}</p>

        <div *ngIf="post.media_url" class="media-container">
          <video *ngIf="post.type === 'video'" [src]="post.media_url" controls class="post-media"></video>
          <audio *ngIf="post.type === 'audio'" [src]="post.media_url" controls class="post-media"></audio>

          <img *ngIf="post.type === 'prayer' && post.media_url" [src]="post.media_url" alt="Contenu de prière" class="post-media-image">
        </div>
      </mat-card-content>

      <mat-card-actions>
        <button mat-button color="accent" (click)="toggleComments(post.id)">
            <mat-icon>comment</mat-icon> Commenter
        </button>
        <button mat-button color="primary" (click)="sharePost(post)">
            <mat-icon>share</mat-icon> Partager
        </button>
      </mat-card-actions>

      <mat-card-content *ngIf="activeCommentPostId === post.id" class="comments-section">
    <mat-divider style="margin: 10px 0;"></mat-divider>

    <app-comments-list
        [postId]="post.id"
        #commentsList>
    </app-comments-list>

    <mat-divider style="margin: 15px 0;"></mat-divider>

    <app-comment-form
        [postId]="post.id"
        (commentSubmitted)="commentsList.addCommentToList($event)">
    </app-comment-form>

      </mat-card-content>
    </mat-card>

    <div *ngIf="posts.length === 0" class="no-content">
      <p>Aucun contenu disponible pour l'instant. Soyez le premier à publier !</p>
    </div>
  </div>
</div>
